name: Quality Checks

on:
  workflow_call:
    inputs:
      python-version:
        description: "Python version for quality checks"
        required: false
        default: "3.13"
        type: string

env:
  FORCE_COLOR: "1"
  PYTHONUNBUFFERED: "1"

jobs:
  code-quality:
    name: Lint, Format, Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.8.8"
          enable-cache: true

      - name: Install go-task
        run: sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin

      - name: Set up Python
        run: uv python install ${{ inputs.python-version }}

      - name: Install dependencies
        run: task install

      - name: Lint
        run: task lint

      - name: Format check
        run: task format:check

      - name: Type check
        run: task typecheck

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.8.8"
          enable-cache: true

      - name: Install go-task
        run: sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin

      - name: Set up Python
        run: uv python install ${{ inputs.python-version }}

      - name: Install dependencies
        run: task install

      - name: Run tests with coverage
        run: task test:ci

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.8.8"
          enable-cache: true

      - name: Install go-task
        run: sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin

      - name: Set up Python
        run: uv python install ${{ inputs.python-version }}

      - name: Install dependencies
        run: task install

      - name: Security scan
        run: task security
        continue-on-error: true

      - name: Secret detection
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: HEAD~1
          head: HEAD
          extra_args: --only-verified
